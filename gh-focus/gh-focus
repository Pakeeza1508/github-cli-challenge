#!/usr/bin/env python3
"""
gh-focus: A distraction-free YouTube CLI for focused learning
GitHub CLI Extension for the 2026 Challenge
"""

import sys
import webbrowser
import subprocess
import shutil
import os
import questionary
from rich import print
from rich.panel import Panel
from rich.columns import Columns
from rich.table import Table
from focus_manager import load_config, add_channel, log_watch, get_watch_stats, get_gist_id, save_gist_id
from fetcher import get_videos, resolve_channel_id

def check_dependencies():
    """Ensure yt-dlp is installed for ID resolution."""
    import importlib.util
    import subprocess
    
    # Check if yt_dlp library is importable in Python
    if importlib.util.find_spec("yt_dlp") is None:
        print(Panel("[yellow]‚öôÔ∏è  First Run Setup: Installing dependencies...[/yellow]", border_style="yellow"))
        try:
            subprocess.check_call([sys.executable, "-m", "pip", "install", "yt-dlp"])
            print("[green]‚úì Dependencies installed![/green]")
        except Exception as e:
            print(f"[red]‚ùå Failed to install yt-dlp. Please run: pip install yt-dlp[/red]")
            sys.exit(1)

def check_gh_auth():
    """Checks if gh CLI is installed and logged in."""
    try:
        subprocess.run(
            ["gh", "auth", "status"],
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL,
            check=True
        )
        return True
    except FileNotFoundError:
        print("[bold red]‚ùå GitHub CLI (gh) is not installed![/bold red]")
        print("Install it here: https://cli.github.com/")
        return False
    except subprocess.CalledProcessError:
        print("[bold red]‚ùå You are not logged into GitHub![/bold red]")
        print("Please run: [yellow]gh auth login[/yellow]")
        return False

def save_to_learning_log(video_title, video_url):
    """Append the video to a shared learning log Gist."""
    if not check_gh_auth():
        return

    print("[bold yellow]üê± Syncing with GitHub...[/bold yellow]")

    gist_id = get_gist_id()
    filename = "focus_learning_log.md"
    new_entry = f"- [ ] **{video_title}** - [Watch]({video_url})\n"

    script_dir = os.path.dirname(os.path.abspath(__file__))
    temp_path = os.path.join(script_dir, filename)

    if not gist_id:
        print("[cyan]Creating new Learning Log Gist...[/cyan]")
        description = "My Developer Learning Path (Created by gh-focus)"

        with open(temp_path, "w", encoding="utf-8") as f:
            f.write(f"# My Intentional Learning Log üß†\n\n{new_entry}")

        try:
            subprocess.run(
                ["gh", "gist", "create", temp_path, "--desc", description, "--public"],
                check=True
            )

            res = subprocess.run(
                ["gh", "gist", "list", "--limit", "1"],
                capture_output=True,
                text=True,
                check=True
            )
            new_id = res.stdout.split()[0]
            save_gist_id(new_id)
            print(f"[bold green]‚úÖ Created & Saved to Gist ID: {new_id}[/bold green]")
        except subprocess.CalledProcessError as exc:
            print("[bold red]‚ùå Failed to create the Learning Log Gist.[/bold red]")
            if exc.stderr:
                print(exc.stderr)
        finally:
            if os.path.exists(temp_path):
                os.remove(temp_path)
    else:
        print(f"[cyan]Updating Gist {gist_id}...[/cyan]")
        try:
            res = subprocess.run(
                ["gh", "gist", "view", gist_id, "--filename", filename],
                capture_output=True,
                text=True,
                check=True
            )
            current_content = res.stdout
            updated_content = current_content + new_entry

            with open(temp_path, "w", encoding="utf-8") as f:
                f.write(updated_content)

            subprocess.run(["gh", "gist", "edit", gist_id, temp_path], check=True)
            print(f"[bold green]‚úÖ Added '{video_title}' to your Learning Log![/bold green]")
        except subprocess.CalledProcessError as exc:
            print("[bold red]‚ùå Failed to update the Learning Log Gist.[/bold red]")
            if exc.stderr:
                print(exc.stderr)
        finally:
            if os.path.exists(temp_path):
                os.remove(temp_path)

def open_safe_mode(video_id):
    """
    Opens video using the local mpv.exe if found, otherwise tries system players.
    """
    url = f"https://www.youtube.com/watch?v={video_id}"
    
    # 1. Check for mpv.exe in the SAME folder as this script
    script_dir = os.path.dirname(os.path.abspath(__file__))
    local_mpv = os.path.join(script_dir, "mpv.exe")
    
    if os.path.exists(local_mpv):
        print(f"[bold green]üöÄ Launching Portable MPV...[/bold green]")
        # We need to pass the full path to yt-dlp if it's not in PATH, 
        # but since you pip installed it, mpv should find it automatically.
        subprocess.run([local_mpv, url])
        return

    # 2. Check for System MPV (Global install)
    if shutil.which("mpv"):
        print(f"[bold green]üöÄ Launching System MPV...[/bold green]")
        subprocess.run(["mpv", url])
        return

    # 3. Check for VLC (Backup)
    vlc_path = shutil.which("vlc")
    if not vlc_path:
        # Check standard Windows paths
        paths = [
            r"C:\Program Files\VideoLAN\VLC\vlc.exe",
            r"C:\Program Files (x86)\VideoLAN\VLC\vlc.exe"
        ]
        for p in paths:
            if os.path.exists(p):
                vlc_path = p
                break
    
    if vlc_path:
        print(f"[bold orange3]üé¨ Launching VLC...[/bold orange3]")
        subprocess.run([vlc_path, url, "--play-and-exit"])
        return

    # 4. Give up and use Browser
    print("[bold red]‚ùå No Player Found![/bold red]")
    print(f"Please copy 'mpv.exe' into this folder: {script_dir}")
    print("[yellow]Falling back to Browser...[/yellow]")
    webbrowser.open(url)

def show_banner():
    """Display welcome banner."""
    print(Panel.fit("[bold white]üéØ YouTube Focus Mode[/bold white]\n[cyan]Curated. Intentional. Focused.[/cyan]", border_style="cyan"))

def view_channels():
    """Display all configured channels by category."""
    config = load_config()
    categories = [key for key, value in config.items() if isinstance(value, list)]
    
    if not categories:
        print("[yellow]No categories found.[/yellow]")
        return
    
    print("\n[bold cyan]üìã Your Channels:[/bold cyan]")
    for cat in categories:
        channels = config[cat]
        if channels:
            print(f"\n[cyan]{cat.upper()}[/cyan]")
            for ch in channels:
                print(f"  ‚Ä¢ {ch['name']} ‚Üí [cyan]{ch['id']}[/cyan]")
        else:
            print(f"\n[cyan]{cat.upper()}[/cyan] (empty)")

def show_dashboard():
    """Display a professional analytics dashboard."""
    stats = get_watch_stats()
    
    if stats.get('total_videos', 0) == 0:
        print(Panel(
            "[dim]No videos watched yet. Start watching to see your dashboard![/dim]",
            title="üìä Dashboard",
            border_style="cyan"
        ))
        return
    
    # Left column: Stats table
    stats_table = Table(show_header=False, box=None, padding=(0, 2))
    stats_table.add_column("Metric", style="bold yellow")
    stats_table.add_column("Value", style="bold white")
    
    stats_table.add_row("üé• Videos Watched", str(stats['total_videos']))
    stats_table.add_row("‚è±Ô∏è  Focus Time (est)", stats['total_time'])
    
    if stats['categories']:
        top_cat = max(stats['categories'], key=stats['categories'].get)
        top_count = stats['categories'][top_cat]
        stats_table.add_row("üî• Top Focus", f"[cyan]{top_cat}[/cyan] ({top_count})")
    
    # Right column: Recent activity
    recent_lines = ["[dim bold]Recent Learning:[/dim bold]"]
    if stats.get('recent'):
        for vid in reversed(stats['recent'][-4:]):
            title_short = vid['title'][:28]
            cat = vid.get('category', '?')
            recent_lines.append(f"[dim]‚Ä¢ [{cat}] {title_short}...[/dim]")
    else:
        recent_lines.append("[dim]No history yet[/dim]")
    
    recent_panel = Panel(
        "\n".join(recent_lines),
        border_style="dim",
        padding=(1, 2)
    )
    
    # Combine into columns
    dashboard = Columns(
        [stats_table, recent_panel],
        equal=True,
        expand=True
    )
    
    print(Panel(
        dashboard,
        title="[bold cyan]üéØ Your Progress[/bold cyan]",
        border_style="green",
        padding=(1, 2)
    ))

def show_stats():
    """Display detailed learning statistics."""
    stats = get_watch_stats()
    
    print(Panel(
        f"[bold cyan]üìä Your Learning Stats[/bold cyan]\n"
        f"[green]Videos Watched:[/green] {stats['total_videos']}\n"
        f"[green]Total Time:[/green] {stats['total_time']}\n"
        f"[green]Categories:[/green] {', '.join([f'{k} ({v})' for k, v in stats['categories'].items()]) if stats['categories'] else 'None'}",
        border_style="cyan"
    ))
    
    if stats['recent']:
        print("\n[bold cyan]üì∫ Recent Videos:[/bold cyan]")
        for video in reversed(stats['recent']):
            date = video.get('timestamp', '').split('T')[0]
            print(f"  ‚úì {video['title'][:50]}... ({date})")

def main():
    check_dependencies()  # Auto-install yt-dlp on first run
    
    # Handle command-line arguments
    if len(sys.argv) > 1:
        if sys.argv[1] == "--stats":
            show_banner()
            show_dashboard()
            return
        elif sys.argv[1] == "--help":
            print("[cyan]Usage:[/cyan]")
            print("  python gh-focus          Start interactive mode")
            print("  python gh-focus --stats  Show dashboard & statistics")
            print("  python gh-focus --help   Show this help message")
            return
    
    show_banner()
    show_dashboard()

    if not check_gh_auth():
        sys.exit(1)

    script_dir = os.path.dirname(os.path.abspath(__file__))
    local_mpv = os.path.join(script_dir, "mpv.exe")
    if not os.path.exists(local_mpv) and not shutil.which("mpv"):
        print(Panel(
            "[yellow]MPV Player not detected![/yellow]\n\n"
            "For the best experience (no ads/shorts), please:\n"
            "1. Download mpv.exe\n"
            f"2. Place it in this folder: [cyan]{script_dir}[/cyan]",
            title="Setup Required"
        ))
        input("Press Enter to continue using Browser Mode...")
    
    # MAIN LOOP: Keeps the app running
    while True:
        config = load_config()
        
        # 1. Ask for Mood (Category)
        categories = [key for key, value in config.items() if isinstance(value, list)]
        main_options = categories + ["üìä View Stats", "üëÄ View Channels", "+ Add New Channel", "Exit"]
        
        choice = questionary.select(
            "What is your focus right now?",
            choices=main_options,
            style=questionary.Style([('answer', 'fg:cyan bold')])
        ).ask()
        
        # Handle Main Menu Exits
        if choice == "Exit":
            print("[bold red]Stay focused! Goodbye. üëã[/bold red]")
            sys.exit()
        
        if choice == "üìä View Stats":
            show_dashboard()
            questionary.confirm("Press Enter to continue...").ask()
            continue
        
        if choice == "üëÄ View Channels":
            view_channels()
            questionary.confirm("Press Enter to continue...").ask()
            continue
            
        if choice == "+ Add New Channel":
            cat = questionary.select(
                "Which category?",
                choices=categories
            ).ask()
            
            user_input = questionary.text(
                "Channel handle (e.g., @Fireship) or URL:"
            ).ask()

            c_id = resolve_channel_id(user_input)
            if c_id:
                name = questionary.text(f"Found ID {c_id}! Enter a display name:").ask()
                if add_channel(cat, name, c_id):
                    print(f"[green]‚úì Added {name} to {cat}![/green]")
                else:
                    print(f"[yellow]Channel already exists in {cat}[/yellow]")
            else:
                print("[bold yellow]‚ö†Ô∏è  Resolution failed. You can enter the ID manually.[/bold yellow]")
                use_manual = questionary.confirm("Enter Channel ID manually (UC...)?").ask()
                if use_manual:
                    c_id = questionary.text("Channel ID (e.g., UCsBjURrPoezykLs9EqgamOA):").ask()
                    name = questionary.text("Channel name (e.g., Fireship):").ask()
                    if add_channel(cat, name, c_id):
                        print(f"[green]‚úì Added {name} to {cat}![/green]")
                    else:
                        print(f"[yellow]Channel already exists in {cat}[/yellow]")
            continue  # Go back to start of loop

        # 2. Fetch Videos for that category
        channels = config[choice]
        if not channels:
            print("[red]No channels in this list yet![/red]")
            print("[yellow]Tip: Select '+ Add New Channel' to get started[/yellow]")
            continue

        # INNER LOOP: Stay in this category until user goes back
        while True:
            videos = get_videos(channels)

            if not videos:
                print("[yellow]No recent videos found.[/yellow]")
                break

            # 3. Create the Selection List
            video_choices = []
            video_map = {}
            video_info = {}
            
            for v in videos:
                # üö´ BLOCK SHORTS: Skip short-form content
                if "#shorts" in v['title'].lower() or "short" in v['title'].lower():
                    continue
                
                # Clean up title for display
                display_text = f"[{v['channel']}] {v['title'][:60]}"
                video_choices.append(display_text)
                video_map[display_text] = v['video_id']
                video_info[display_text] = v
            
            if not video_choices:
                print("[yellow]No full-length videos found (only Shorts).[/yellow]")
                break
            
            # Add Navigation
            video_choices.append("üîô Go Back")
            video_choices.append("‚ùå Exit App")
            
            selected_text = questionary.select(
                f"üì∫ {choice.upper()} - Select video:",
                choices=video_choices
            ).ask()
            
            # Navigation Logic
            if selected_text == "‚ùå Exit App":
                print("[bold red]Goodbye! üëã[/bold red]")
                sys.exit()
                
            if selected_text == "üîô Go Back":
                break  # Breaks inner loop, goes back to Main Menu
                
            # Choose action for the selected video
            video_id = video_map[selected_text]
            video_data = video_info[selected_text]
            action = questionary.select(
                f"Action for: {selected_text.split('|')[-1].strip()}",
                choices=[
                    "üì∫ Stream (Watch Now)",
                    "üíæ Save to Learning Log",
                    "üîô Cancel"
                ]
            ).ask()

            if action == "üì∫ Stream (Watch Now)":
                print(f"\n[bold yellow]üé¨ {selected_text}[/bold yellow]")
                print("[dim]YouTube will open. Close the tab when done to return here.[/dim]\n")

                log_watch(
                    video_data['title'],
                    video_data['channel'],
                    video_id,
                    choice
                )

                open_safe_mode(video_id)
            elif action == "üíæ Save to Learning Log":
                clean_title = selected_text.split("] ")[-1]
                full_url = f"https://www.youtube.com/watch?v={video_id}"
                save_to_learning_log(clean_title, full_url)
                input("Press Enter to continue...")
            # The loop continues, so you come back to the video list!

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n[bold red]Force Exit. Stay focused! üëã[/bold red]")
        sys.exit(0)
    except Exception as e:
        print(f"[red]Error: {e}[/red]")
        sys.exit(1)
