#!/usr/bin/env python3
"""
gh-focus: A distraction-free YouTube CLI for focused learning
GitHub CLI Extension for the 2026 Challenge
"""

import sys
import webbrowser
import subprocess
import shutil
import os
import questionary
from rich import print
from rich.panel import Panel
from focus_manager import load_config, add_channel, log_watch, get_watch_stats
from fetcher import get_videos

def open_safe_mode(video_id):
    """
    Opens video using the local mpv.exe if found, otherwise tries system players.
    """
    url = f"https://www.youtube.com/watch?v={video_id}"
    
    # 1. Check for mpv.exe in the SAME folder as this script
    script_dir = os.path.dirname(os.path.abspath(__file__))
    local_mpv = os.path.join(script_dir, "mpv.exe")
    
    if os.path.exists(local_mpv):
        print(f"[bold green]üöÄ Launching Portable MPV...[/bold green]")
        # We need to pass the full path to yt-dlp if it's not in PATH, 
        # but since you pip installed it, mpv should find it automatically.
        subprocess.run([local_mpv, url])
        return

    # 2. Check for System MPV (Global install)
    if shutil.which("mpv"):
        print(f"[bold green]üöÄ Launching System MPV...[/bold green]")
        subprocess.run(["mpv", url])
        return

    # 3. Check for VLC (Backup)
    vlc_path = shutil.which("vlc")
    if not vlc_path:
        # Check standard Windows paths
        paths = [
            r"C:\Program Files\VideoLAN\VLC\vlc.exe",
            r"C:\Program Files (x86)\VideoLAN\VLC\vlc.exe"
        ]
        for p in paths:
            if os.path.exists(p):
                vlc_path = p
                break
    
    if vlc_path:
        print(f"[bold orange3]üé¨ Launching VLC...[/bold orange3]")
        subprocess.run([vlc_path, url, "--play-and-exit"])
        return

    # 4. Give up and use Browser
    print("[bold red]‚ùå No Player Found![/bold red]")
    print(f"Please copy 'mpv.exe' into this folder: {script_dir}")
    print("[yellow]Falling back to Browser...[/yellow]")
    webbrowser.open(url)

def show_banner():
    """Display welcome banner."""
    print(Panel.fit("[bold white]üéØ YouTube Focus Mode[/bold white]\n[cyan]Curated. Intentional. Focused.[/cyan]", border_style="cyan"))

def show_stats():
    """Display learning statistics."""
    stats = get_watch_stats()
    
    print(Panel(
        f"[bold cyan]üìä Your Learning Stats[/bold cyan]\n"
        f"[green]Videos Watched:[/green] {stats['total_videos']}\n"
        f"[green]Total Time:[/green] {stats['total_time']}\n"
        f"[green]Categories:[/green] {', '.join([f'{k} ({v})' for k, v in stats['categories'].items()]) if stats['categories'] else 'None'}",
        border_style="cyan"
    ))
    
    if stats['recent']:
        print("\n[bold cyan]üì∫ Recent Videos:[/bold cyan]")
        for video in reversed(stats['recent']):
            date = video.get('timestamp', '').split('T')[0]
            print(f"  ‚úì {video['title'][:50]}... ({date})")

def main():
    # Handle command-line arguments
    if len(sys.argv) > 1:
        if sys.argv[1] == "--stats":
            show_stats()
            return
        elif sys.argv[1] == "--help":
            print("[cyan]Usage:[/cyan]")
            print("  python gh-focus          Start interactive mode")
            print("  python gh-focus --stats  Show learning statistics")
            print("  python gh-focus --help   Show this help message")
            return
    
    show_banner()
    
    # MAIN LOOP: Keeps the app running
    while True:
        config = load_config()
        
        # 1. Ask for Mood (Category)
        main_options = list(config.keys()) + ["üìä View Stats", "+ Add New Channel", "Exit"]
        
        choice = questionary.select(
            "What is your focus right now?",
            choices=main_options,
            style=questionary.Style([('answer', 'fg:cyan bold')])
        ).ask()
        
        # Handle Main Menu Exits
        if choice == "Exit":
            print("[bold red]Stay focused! Goodbye. üëã[/bold red]")
            sys.exit()
        
        if choice == "üìä View Stats":
            show_stats()
            questionary.confirm("Press Enter to continue...").ask()
            continue
            
        if choice == "+ Add New Channel":
            cat = questionary.select(
                "Which category?", 
                choices=list(config.keys())
            ).ask()
            
            name = questionary.text("Channel Name (e.g., Fireship):").ask()
            c_id = questionary.text("Channel ID (starts with UC...):").ask()
            
            if add_channel(cat, name, c_id):
                print(f"[green]‚úì Added {name} to {cat}![/green]")
            else:
                print(f"[yellow]Channel already exists in {cat}[/yellow]")
            continue  # Go back to start of loop

        # 2. Fetch Videos for that category
        channels = config[choice]
        if not channels:
            print("[red]No channels in this list yet![/red]")
            print("[yellow]Tip: Select '+ Add New Channel' to get started[/yellow]")
            continue

        # INNER LOOP: Stay in this category until user goes back
        while True:
            videos = get_videos(channels)

            if not videos:
                print("[yellow]No recent videos found.[/yellow]")
                break

            # 3. Create the Selection List
            video_choices = []
            video_map = {}
            video_info = {}
            
            for v in videos:
                # üö´ BLOCK SHORTS: Skip short-form content
                if "#shorts" in v['title'].lower() or "short" in v['title'].lower():
                    continue
                
                # Clean up title for display
                display_text = f"[{v['channel']}] {v['title'][:60]}"
                video_choices.append(display_text)
                video_map[display_text] = v['video_id']
                video_info[display_text] = v
            
            if not video_choices:
                print("[yellow]No full-length videos found (only Shorts).[/yellow]")
                break
            
            # Add Navigation
            video_choices.append("üîô Go Back")
            video_choices.append("‚ùå Exit App")
            
            selected_text = questionary.select(
                f"üì∫ {choice.upper()} - Select video:",
                choices=video_choices
            ).ask()
            
            # Navigation Logic
            if selected_text == "‚ùå Exit App":
                print("[bold red]Goodbye! üëã[/bold red]")
                sys.exit()
                
            if selected_text == "üîô Go Back":
                break  # Breaks inner loop, goes back to Main Menu
                
            # Launch Video
            video_id = video_map[selected_text]
            video_data = video_info[selected_text]
            print(f"\n[bold yellow]üé¨ {selected_text}[/bold yellow]")
            print("[dim]YouTube will open. Close the tab when done to return here.[/dim]\n")
            
            # Log the watch
            log_watch(
                video_data['title'],
                video_data['channel'],
                video_id,
                choice
            )
            
            open_safe_mode(video_id)
            # The loop continues, so you come back to the video list!

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n[bold red]Force Exit. Stay focused! üëã[/bold red]")
        sys.exit(0)
    except Exception as e:
        print(f"[red]Error: {e}[/red]")
        sys.exit(1)
